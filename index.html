<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gountain</title>

  <!-- PWA / Manifest (SIN ?v=) -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#00a0c6" />
  <meta name="background-color" content="#ffffff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gountain" />

  <!-- Icons (con cache-busting) -->
  <link rel="icon" type="image/png" sizes="192x192" href="/assets/Gountain-192.png?v=14" />
  <link rel="apple-touch-icon" sizes="512x512" href="/assets/Gountain-512.png?v=14" />

  <!-- Mapbox GL v2 -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" defer></script>

  <!-- CSS de la app -->
  <link rel="stylesheet" href="/styles.css?v=13" />
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <button id="btnMenu" class="hamburger" aria-label="Abrir filtros">
      <span class="bars"></span>
    </button>
    <h1>Gountain</h1>
    <select id="continent-select" aria-label="Filtrar continente">
      <option value="">Todos los continentes</option>
      <option value="América del Norte">América del Norte</option>
      <option value="América del Sur">América del Sur</option>
      <option value="Europa">Europa</option>
      <option value="África">África</option>
      <option value="Asia">Asia</option>
      <option value="Oceanía">Oceanía</option>
      <option value="Antártida">Antártida</option>
    </select>
    <button id="btnInfo" class="info-btn" aria-label="Open glossary">ℹ️</button>
  </header>

  <div id="layout">
    <!-- Paneles -->
    <aside id="sidebar" class="panel hidden" aria-label="Panel de filtros">
      <div class="panel-section">
        <h2>Filtros</h2>
        <details>
        <summary>Dificultad</summary>
        <div id="filter-dificultad" class="chips"></div>
      </details>
      <details>
        <summary>Botas</summary>
        <div id="filter-botas" class="chips"></div>
      </details>
      <details>
        <summary>Tipo</summary>
        <div id="filter-tipo" class="chips"></div>
      </details>
      <details>
        <summary>Altitud (m)</summary>
        <div class="altitude-inputs">
          <label for="alt-min">Min</label>
          <input id="alt-min" class="input" type="number" aria-label="Altitud mínima">
          <label for="alt-max">Max</label>
          <input id="alt-max" class="input" type="number" aria-label="Altitud máxima">
          <div id="altitude-chip" class="chips"></div>
        </div>
      </details>
      <details>
        <summary>Temporada</summary>
        <div id="filter-season" class="chips"></div>
      </details>
      <button id="clearFilters" class="btn">Limpiar filtros</button>
    </div>
  </aside>

    <!-- Mapa -->
    <section id="map-container">
      <div id="map"></div>
      <!-- Botón Layers -->
      <button id="layers-toggle" class="layers-btn" aria-label="Mostrar estilos de mapa" aria-pressed="false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" aria-hidden="true" class="icon">
          <polygon points="12 3 20 8 12 13 4 8"></polygon>
          <path d="M20 12L12 17 4 12"></path>
        </svg>
        <span class="label">Layers</span>
      </button>

      <!-- Switcher oculto por defecto -->
      <div id="basemap-switcher" class="basemap-switcher hidden" aria-label="Map style"></div>
      <div id="dest-chips" class="destination-chips" aria-label="Destinations"></div>
      <div id="map-error" class="hidden" role="alert"></div>
    </section>
  </div>

  <aside id="glossary" class="panel hidden" aria-label="Glosario">
    <div class="panel-section">
      <h2>Glosario</h2>
      <details open>
        <summary>Siglas</summary>
        <ul>
          <li><b>PN</b>: Parque Nacional (normas de acampada y gas)</li>
          <li><b>UIAA</b>: Escala internacional de dificultad</li>
          <li><b>F</b>: Fácil</li>
          <li><b>PD</b>: Poco Difícil</li>
          <li><b>AD</b>: Bastante Difícil</li>
          <li><b>D</b>: Difícil</li>
          <li><b>Vivac</b>: Pernocta con tienda ligera (montar al atardecer, recoger al amanecer)</li>
          <li><b>Scrambling</b>: Progresión con manos/pies en roca sin ser escalada deportiva</li>
        </ul>
      </details>
      <details id="boots-legend" open>
        <summary>Leyenda de botas</summary>
        <ul id="legend-botas">
          <li>Cualquiera</li>
          <li>Depende</li>
          <li>Bestard Teix Lady GTX</li>
          <li>Scarpa Ribelle Lite HD</li>
          <li>Scarpa Zodiac Tech LT GTX</li>
          <li>La Sportiva Aequilibrium ST GTX</li>
          <li>La Sportiva Nepal Cube GTX</li>
          <li>Nepal (doble bota técnica de alta montaña)</li>
        </ul>
      </details>
    </div>
  </aside>

  <!-- JS de tu app -->
  <script type="module" src="/dist/app.bundle.js?v=13"></script>
  <script type="module" src="/map.js?v=13"></script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw-v14.js?v=14').catch(console.error);
      });
    }
  </script>

  <noscript>Esta app necesita JavaScript para funcionar.</noscript>

  <!-- Filters UI -->
  <script>
/* ============ Gountain – Filters UI (v14 fix) ============ */
(() => {
  if (window.__FILTERS_UI_WIRED__) return;           // evita doble wiring
  window.__FILTERS_UI_WIRED__ = true;

  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // Elementos fijos
  const sidebar  = $('#sidebar');
  const select   = $('#continent-select');
  const clearBtn = $('#clearFilters');
  const altMin   = $('#alt-min');
  const altMax   = $('#alt-max');

  // Estado único y exportable
  const S = (window.__FILTERS__ = window.__FILTERS__ || {
    continent: '',
    dificultad: new Set(),
    botas: new Set(),
    tipo: new Set(),
    season: new Set(),
    altMin: null,
    altMax: null
  });

  // Opciones (sobrescribibles)
  const OPT = Object.assign({
    dificultad: ['F','PD','AD','D'],
    botas: [
      'Cualquiera','Depende','Bestard Teix Lady GTX','Scarpa Ribelle Lite HD',
      'Scarpa Zodiac Tech LT GTX','La Sportiva Aequilibrium ST GTX',
      'La Sportiva Nepal Cube GTX','Nepal (doble bota técnica de alta montaña)'
    ],
    tipo: ['Travesía','Ascensión','Circular','Lineal','Alpinismo','Scrambling'],
    season: ['Invierno','Primavera','Verano','Otoño']
  }, window.__FILTER_OPTIONS__ || {});

  // Render de chips idempotente
  function renderChips(containerId, options, key) {
    const host = document.getElementById(containerId);
    if (!host) return;
    host.innerHTML = '';
    options.forEach(opt => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = opt;
      b.dataset.key = key;
      b.dataset.value = opt;
      b.setAttribute('aria-pressed','false');
      host.appendChild(b);
    });
  }
  renderChips('filter-dificultad', OPT.dificultad, 'dificultad');
  renderChips('filter-botas',      OPT.botas,      'botas');
  renderChips('filter-tipo',       OPT.tipo,       'tipo');
  renderChips('filter-season',     OPT.season,     'season');

  // Emisión a map.js
  function emit() {
    const payload = {
      continent: S.continent || '',
      dificultad: Array.from(S.dificultad),
      botas: Array.from(S.botas),
      tipo: Array.from(S.tipo),
      season: Array.from(S.season),
      altMin: S.altMin,
      altMax: S.altMax
    };
    window.dispatchEvent(new CustomEvent('gountain:filters-changed', { detail: payload }));
  }

  // Delegación de clicks en chips (un solo listener)
  document.body.addEventListener('click', (e) => {
    const b = e.target.closest('.chip');
    if (!b || !sidebar?.contains(b)) return;

    const key = b.dataset.key;     // dificultad | botas | tipo | season
    const val = b.dataset.value;
    const set = S[key];
    if (!(set instanceof Set)) return;

    if (set.has(val)) {
      set.delete(val);
      b.classList.remove('active');
      b.setAttribute('aria-pressed','false');
    } else {
      set.add(val);
      b.classList.add('active');
      b.setAttribute('aria-pressed','true');
    }
    emit();
  });

  // Altitud con debounce + chip sintético
  let altTimer = null;
  function onAltChange() {
    clearTimeout(altTimer);
    altTimer = setTimeout(() => {
      S.altMin = altMin?.value !== '' ? Number(altMin.value) : null;
      S.altMax = altMax?.value !== '' ? Number(altMax.value) : null;
      emit();
    }, 180);
  }
  altMin?.addEventListener('input', onAltChange);
  altMax?.addEventListener('input', onAltChange);

  // Continente
  select?.addEventListener('change', () => {
    S.continent = select.value || '';
    emit();
  });

  // Limpiar filtros
  clearBtn?.addEventListener('click', () => {
    S.dificultad.clear();
    S.botas.clear();
    S.tipo.clear();
    S.season.clear();
    S.altMin = S.altMax = null;

    $$('#sidebar .chip.active').forEach(b => {
      b.classList.remove('active');
      b.setAttribute('aria-pressed','false');
    });
    if (altMin) altMin.value = '';
    if (altMax) altMax.value = '';
    emit();
  });

  // Primer disparo para sincronizar mapa al cargar
  emit();
})();
</script>
</body>
</html>
